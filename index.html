<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/country-info/assets/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/main.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/media-queries.css" type="text/css">
</head>
<body>
  <div class="container">
    <section class="search-component">
      <h1>Country info</h1>
      <label>
        <input type="search" name="searchCountry" placeholder="type country name" id="" autocomplete="off">
        <input type="button" value="show">
      </label>
    </section>
    <section class="results-component"></section>

  </div>

</body>
<script>
  let countryAPI = `http://api.worldbank.org/v2/country/br?format=json`;
  let par = document.querySelector("p.mini-results");
  let parResults = document.querySelector("p.full-results");
  let search = document.querySelector("input[name='searchCountry']");
  let val;
  let controller = new AbortController();

  search.addEventListener("input", async e => {
    console.clear();
    controller.abort();
    controller = new AbortController();

    if (search.value == "") {
      let divFound = document.querySelector(".search-component > label > div");
      divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
      return;
    }

    let divFound = document.querySelector(".search-component > label > div");
    if (divFound) divFound.remove();
    let number = 0;
    let div = document.createElement('div');
    let ul = document.createElement('ul');
    let li = document.createElement('li');
    div.style.position = "absolute";
    div.style.top = "40px";
    div.style.width = "90%";
    div.style.backgroundColor = "white";
    div.style.display = "block";
    // div.style.minHeight = "150px";
    div.appendChild(ul);

    let foundCountries = await getCountry(div);

    if (foundCountries.length == 0) {
      let divFound = document.querySelector(".search-component > label > div");
      if (!divFound) search.parentElement.appendChild(div);
      let p2 = document.querySelector(".search-component > label > div > p");
      if (p2) p2.remove();
      let p = document.createElement('p');
      p.innerHTML = "nothing found";
      div.appendChild(p);
      console.log("----NOT FOUND------TCL: div", div.innerHTML)
    } else {
      search.parentElement.appendChild(div);
      console.log("******SEARCHING*********TCL: div", div.innerHTML)
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";
    }

    try {
      let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
      let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));
      let errArr = [];
      console.log(`DO SOMTH ${foundCountries.length}`, doSmthAll);


      for (let i = 0; i < foundCountries.length; i++) {
        try {
          // alert(foundCountries.length) 

          if (number < 10) {
            number++;
            // console.log("TCL: number", number)
            if (number == 1) {
              ul.innerHTML = "";
            }
            let li = document.createElement('li');
            li.innerHTML = `${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}, capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
            // console.log("TCL: li", li.textContent)
            ul.appendChild(li);
            let p = document.querySelector(".search-component > label > div > p");
            if (p) p.remove();
            // console.log("TCL: ul", ul.innerHTML)
            console.log("******CURRENT******TCL: div", div.innerHTML)
          } else if (number == 10) {
            number++;
            let p = document.createElement('p');
            p.innerHTML = "...";
            div.appendChild(p);
          }

        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`TYPE_ERROR_MY ${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}\n`, err);
            errArr.push(i);
            number--;
          } else {
            console.error("UKNOWN_ERROR_MY\n", err);
          }
        }
      }



      let searchAllBtn = document.querySelector(".search-component > label > input[type='button']");
      let resultsComp = document.querySelector(".results-component");
      let num = 0;
      // let indexArr = 0;
      // let num = 1;
      function miniResults() {
        resultsComp.innerHTML = "";
        for (let i = 0; i < foundCountries.length; i++) {
          // if (i == errArr[indexArr]) {
          //   indexArr++;
          //   continue;
          // }
          try {
            num++
            let div = document.createElement("div");
            let p = document.createElement("p");
            let img = document.createElement("img");
            img.src= `https://www.countryflags.io/${foundCountries[i]["alpha-2"]}/flat/64.png`;
            p.innerHTML = `#${num} <br> [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}<br> capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
            div.className = "mini-result";
            div.appendChild(p);
            div.appendChild(img);
            resultsComp.appendChild(div);
            // num++;
          } catch (err) {
            if (err instanceof TypeError) {
              console.error(`TYPE_ERROR_IN_FUNC_MY ${num}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}\n`, err);
              num--;
            } else {
              console.error("UKNOWN_ERROR_MY\n", err);
            }
          }
        }
        let p = document.createElement("p");
        p.innerHTML = `<strong>Found ${num} countries:</strong>`
        resultsComp.insertBefore(p, resultsComp.firstElementChild);
      }
      searchAllBtn.addEventListener("click", miniResults);




    } catch (err) {
      if (err instanceof DOMException) {
        console.error("ABORT_ERROR_MY\n", err);
      } else {
        console.error("UKNOWN_ERROR_MY_OUTER\n", err);
      }

    }
  });

  async function getCountry(elt1) {
    const countriesJson = await fetch("country.json");
    const countries = await countriesJson.json();

    const foundCountries = countries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    let p = document.createElement('p');
    p.innerHTML = "Searching, wait a bit"
    elt1.appendChild(p);

    return foundCountries;
  }




</script>
</html>