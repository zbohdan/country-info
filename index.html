<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/country-info/assets/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/main.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/media-queries.css" type="text/css">
</head>
<body>
  <div class="container">
    <section class="search-component">
      <h1>Country info</h1>
      <label>
        <input name="searchCountry" placeholder="type country name" id="" autocomplete="off" tabindex="2">
        <input type="button" name="showBtn" value="show">
      </label>
    </section>
    <section class="results-component"></section>

  </div>

</body>
<script>
  let countryAPI = `http://api.worldbank.org/v2/country/br?format=json`;
  let search = document.querySelector("input[name='searchCountry']");
  let inputBtn = document.querySelector("input[name='showBtn']")
  let controller = new AbortController();


  let label = document.querySelector('.search-component > label')
  label.addEventListener("click", (e) => e.preventDefault());


  search.focus();
  search.addEventListener("keydown", e => {
    if (e.key == "Enter") {
      inputBtn.dispatchEvent(new Event("click"));
    }
  })
  search.addEventListener("input", async e => {
    console.clear();
    controller.abort();
    controller = new AbortController();



    if (search.value == "") {
      let divFound = document.querySelector(".search-component > label > div");
      divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
      return;
    }

    let divFound = document.querySelector(".search-component > label > div");
    if (divFound) divFound.remove();
    let number = 0;
    let div = document.createElement('div');
    let ul = document.createElement('ul');
    let li = document.createElement('li');
    // div.style.position = "absolute";
    // div.style.top = "40px";
    div.style.width = "90%";
    div.style.backgroundColor = "white";
    div.style.display = "block";
    // div.style.minHeight = "150px";
    div.appendChild(ul);

    let foundCountries = await getCountry(div);

    if (foundCountries.length == 0) {
      let divFound = document.querySelector(".search-component > label > div");
      if (!divFound) search.parentElement.insertBefore(div, inputBtn);
      let p2 = document.querySelector(".search-component > label > div > p");
      if (p2) p2.remove();
      let p = document.createElement('p');
      p.innerHTML = "nothing found";
      div.appendChild(p);
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";
    } else {
      search.parentElement.insertBefore(div, inputBtn);
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";
    }

    try {
      let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
      let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));


      for (let i = 0; i < foundCountries.length; i++) {
        try {
          // alert(foundCountries.length) 

          if (number < 10) {
            number++;
            if (number == 1) {
              ul.innerHTML = "";
            }
            let li = document.createElement('li');
            li.innerHTML = `${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}, capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
            li.addEventListener("click", e => {
              search.value = `${foundCountries[i]["name"]}`;
              search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
              let divFound = document.querySelector(".search-component > label > div");
              divFound.remove();
            });
            ul.appendChild(li);
            let p = document.querySelector(".search-component > label > div > p");
            if (p) p.remove();
          } else if (number == 10) {
            number++;
            let p = document.createElement('p');
            p.innerHTML = "...";
            div.appendChild(p);
          }

        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`TYPE_ERROR_MY ${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}\n`, err);
            number--;
          } else {
            console.error("UKNOWN_ERROR_MY\n", err);
          }
        }
      }



      // let searchAllBtn = document.querySelector(".search-component > label > input[type='button']");
      let resultsComp = document.querySelector(".results-component");
      let ownSearch;
      // let indexArr = 0;
      // let num = 1;
      async function miniResults(e) {

        // searchAllBtn.removeEventListener("click", miniResults);
        // search.dispatchEvent(new Event('input'));
        // alert(number)
        let num = 0;
        resultsComp.innerHTML = "";
        let divFound = document.querySelector(".search-component > label > div");
        ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
        console.log(`Меня кинуло сюда: ${ownSearch.length} -`, ownSearch);
        if (ownSearch.length == 0) return;

        if (ownSearch.length == 1) {  // change condition
          if (divFound) divFound.remove();
          search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
          showInfo(ownSearch[0]["name"]);
        } else {
          for (let i = 0; i < ownSearch.length; i++) {
            // if (i == errArr[indexArr]) {
            //   indexArr++;
            //   continue;
            // }
            try {
              num++
              let div = document.createElement("div");
              let p = document.createElement("p");
              let img = document.createElement("img");

              img.src = `https://www.countryflags.io/${ownSearch[i]["alpha-2"]}/flat/64.png`;
              p.innerHTML = `#${num} <br> [${ownSearch[i]["alpha-2"]}] ${ownSearch[i]["name"]}<br> capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
              div.className = "mini-result";
              div.tabIndex = 0;
              div.appendChild(p);
              div.appendChild(img);
              resultsComp.appendChild(div);

              div.addEventListener("keydown", e => {
                if (e.key == "Enter") {
                  div.dispatchEvent(new Event("click"));
                }
              });

              div.addEventListener("click", async e => {
                console.log("click");
                search.value = ownSearch[i]["name"];
                search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
                if (divFound) divFound.remove();
                showInfo(search.value);
              });
            } catch (err) {
              if (err instanceof TypeError) {
                console.error(`TYPE_ERROR_IN_FUNC_MY ${num}. [${ownSearch[i]["alpha-2"]}] ${ownSearch[i]["name"]}\n`, err);
                num--;
              } else {
                console.error("UKNOWN_ERROR_MY\n", err);
              }
            }
          }
          if (divFound) divFound.remove();
          search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
          let p = document.createElement("p");
          p.innerHTML = `<strong>Found ${num} countries:</strong>`;
          console.log(`Может проблема в корневом #1: ${resultsComp.innerHTML}`);
          resultsComp.insertBefore(p, resultsComp.firstElementChild);
          console.log(`Может проблема в корневом #2: ${resultsComp.innerHTML}`);
        }
      }
      // function searchEnter(e) {
      //   if (e.key == "Enter") {
      //     inputBtn.dispatchEvent(new Event("click"));
      //   }
      // }

      inputBtn.onclick = miniResults;

      async function showInfo(countryName) {
        let ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(countryName.toLowerCase()));
        let singleCountry = ownSearch.filter(i => i.name == countryName);
        singleCountry = singleCountry[0];
        console.log("TCL: showInfo -> singleCountry", singleCountry['name'])
        console.log(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
        // let singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
        // let singleCap = await singleCapJson.json();
        // let singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
        let singleCap = await getSingleCountry(singleCountry["alpha-2"])
        let div = document.createElement("div");
        let p = document.createElement("p");
        let img = document.createElement("img");
        img.src = `https://www.countryflags.io/${singleCountry["alpha-2"]}/flat/64.png`;
        p.innerHTML = `INFO <br> [${singleCountry["alpha-2"]}] ${singleCountry["name"]}<br> capital: ${singleCap[1][0]["capitalCity"]}`;
        div.className = "mini-result-single";
        div.appendChild(p);
        div.appendChild(img);
        resultsComp.innerHTML = "";
        resultsComp.appendChild(div);
        return `HELLO ${countryName}`;
      }

      async function getSingleCountry(country) {
        const singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${country}?format=json`);
        const singleCap = await singleCapJson.json();
        return singleCap;
      }

    } catch (err) {
      if (err instanceof DOMException) {
        console.error("ABORT_ERROR_MY\n", err);
      } else {
        console.error("UKNOWN_ERROR_MY_OUTER\n", err);
      }

    }
  });

  async function getCountry(elt1) {
    const countriesJson = await fetch("country.json");
    const countries = await countriesJson.json();

    const foundCountries = countries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    let p = document.createElement('p');
    p.innerHTML = "Searching, wait a bit"
    elt1.appendChild(p);

    return foundCountries;
  }




</script>
</html>