<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/country-info/assets/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/main.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/media-queries.css" type="text/css">
</head>
<body>
    <div class="container">
      <section class="search-component">
        <h1>Country info</h1>
        <label>
          <input type="search" name="searchCountry" id="" autocomplete="false">
        </label>
        <p class="mini-results"></p>
        <p class="full-results"></p>
      </section>

    </div>
    
</body>
<script>
  let countryAPI = `http://api.worldbank.org/v2/country/br?format=json`
  let par = document.querySelector("p.mini-results");
  let parResults = document.querySelector("p.full-results");
  let search = document.querySelector("input[name='searchCountry']");
  let val;
  let controller = new AbortController();
  // var signal = controller.signal;
  // let abortBtn = document.querySelector(".abort");
  // abortBtn.addEventListener("click", (e) => {
  //   controller.abort();
  //   console.log('Download aborted');
  // });

  search.addEventListener("input", async (e) => {
    // val = getCountry().then(resolve => alert(resolve[0].name));
    // abortBtn.dispatchEvent(new Event("click"));
    controller.abort();
    controller = new AbortController();
    

      let foundCountries = await getCountry();
      let c = 1;

      foundCountries.forEach(async i => {
        try {
          // alert(foundCountries.length) 
          let newDataJson = await fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, {signal: controller.signal});
          let newData = await newDataJson.json();
          if (c == 1) parResults.innerHTML = "";
          parResults.innerHTML += `${c++}. [${i["alpha-2"]}] ${i["name"]}, capital: ${newData[1][0]["capitalCity"]} </br>`;
        } catch(err) {
          if (err instanceof TypeError) {
            console.log(`${c-1}. [${i["alpha-2"]}] ${i["name"]}`);
            c--;
          } else if (err instanceof DOMException) {
            console.log("ABORT", err);
          }
        }
          // parResults.innerHTML += `<strong style="background-color:yellow"> ${c-1}. [${i["alpha-2"]}] ${i["name"]}, capital: uknown </br> </strong>`;
      }); 
      if (foundCountries.length == 0) parResults.innerHTML = "nothing found";

      // let stopThings = await makeThings;
      // alert(stopThings);
      
      
      // getCountry().then(resolve => {
      //     parResults.innerHTML = "";
      //     let c = 1;
      //     resolve.forEach(i => fetch(`http://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, {signal: controller.signal})
      //     .then(resolve => resolve.json())
      //     .then(json => {
            
      //       parResults.innerHTML += `${c++}. [${i["alpha-2"]}] ${i["name"]}, capital: ${json[1][0]["capitalCity"]} </br>`;
      //     }));
      // })
    // alert(val[232]["name"])
    // alert(val);
    // par.innerHTML = val.join(" ");
    // search.innerHTML
  });
  // getCountry()
  //   .then(resolve => alert(resolve[248]["name"]));
  async function getCountry(){
    const countriesJson = await fetch("country.json");
    const countries = await countriesJson.json();

    const foundCountries = await countries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    parResults.innerHTML = "Searching, wait a bit";
    // const found

    return foundCountries;
  }
</script>
</html>