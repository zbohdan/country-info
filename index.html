<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/country-info/assets/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/main.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/media-queries.css" type="text/css">
</head>
<body>
  <div class="container">
    <section class="search-component">
      <h1>Country info</h1>
      <label>
        <input name="searchCountry" placeholder="type country name" id="" autocomplete="off" tabindex="2">
        <input type="button" name="showBtn" value="show">
      </label>
    </section>
    <section class="results-component"></section>

  </div>

</body>
<script>
  let countryAPI = `http://api.worldbank.org/v2/country/br?format=json`;
  let search = document.querySelector("input[name='searchCountry']");
  let inputBtn = document.querySelector("input[name='showBtn']")
  let controller = new AbortController();


  let label = document.querySelector('.search-component > label')
  label.addEventListener("click", (e) => e.preventDefault());


  search.focus();
  search.addEventListener("keydown", e => {
    if (e.key == "Enter") {
      inputBtn.dispatchEvent(new Event("click"));
    }
  })

  // --------------------------------------------
  //            INPUT LISTENER
  // --------------------------------------------

  search.addEventListener("input", async e => {
    // console.clear();
    controller.abort();
    controller = new AbortController();



    if (search.value == "") {
      let divFound = document.querySelector(".search-component > label > div");
      divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
      return;
    }

    let divFound = document.querySelector(".search-component > label > div");
    if (divFound) divFound.remove();
    let number = 0;
    let div = document.createElement('div');
    let ul = document.createElement('ul');
    // div.style.position = "absolute";
    // div.style.top = "40px";
    div.style.width = "90%";
    div.style.backgroundColor = "white";
    div.style.display = "block";
    // div.style.minHeight = "150px";
    div.appendChild(ul);

    let foundCountries = await getCountry(div);
    search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";

    // --------------------------------------------
    //    PRELIMINARY CHECK OF COUNTRY EXISTENCE
    // --------------------------------------------

    if (foundCountries.length == 0) {
      let divFound = document.querySelector(".search-component > label > div");
      if (!divFound) search.parentElement.insertBefore(div, inputBtn);

      let pFound = document.querySelector(".search-component > label > div > p");
      if (pFound) {
        pFound.innerHTML = "nothing found";
      } else {
        let p = document.createElement('p');
        p.innerHTML = "nothing found";
        div.appendChild(p);
      }
    } else {
      search.parentElement.insertBefore(div, inputBtn);
    }

    // --------------------------------------------
    //           CREATING OFFER LIST
    // --------------------------------------------

    try {
      let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
      let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));

      for (let i = 0; i < foundCountries.length; i++) {
        try {
          if (number < 10) {
            number++;
            if (number == 1) {
              ul.innerHTML = "";
            }

            let li = document.createElement('li');
            li.innerHTML = `${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}, capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
            li.tabIndex = 0;

            li.addEventListener("keydown", e => {
              if (e.key == "Enter") {
                li.dispatchEvent(new Event("click"));
              }
            });

            li.addEventListener("click", e => {
              search.value = `${foundCountries[i]["name"]}`;
              search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
              let divFound = document.querySelector(".search-component > label > div");
              divFound.remove();
              inputBtn.dispatchEvent(new Event('click'));
            });
            ul.appendChild(li);
            let pFound = document.querySelector(".search-component > label > div > p");
            if (pFound) pFound.remove();
          } else if (number == 10) {
            number++;
            let p = document.createElement('p');
            p.innerHTML = "...";
            div.appendChild(p);
          }

        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`TYPE_ERROR_MY ${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}\n`, err);
            number--;
          } else {
            console.error("UKNOWN_ERROR_MY\n", err);
          }
        }
      }
    } catch (err) {
      if (err instanceof DOMException) {
        console.error("ABORT_ERROR_MY\n", err);
      } else {
        console.error("UKNOWN_ERROR_MY_OUTER\n", err);
      }

    }
  });

  // --------------------------------------------
  //      SHOW BUTTON ONCLICK LISTENER
  // --------------------------------------------

  async function miniResults(e) {
    let successResArr = [];
    let failArr = [];
    let divMiniResults = document.createElement('div');
    let divFound = document.querySelector(".search-component > label > div");

    let resultsComp = document.querySelector(".results-component");
    resultsComp.innerHTML = "";

    let foundCountries = await getCountry(resultsComp);

    let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
    let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));

    let ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    console.log(`Меня кинуло сюда: ${ownSearch.length} -`, ownSearch);

    // --------------------------------------------
    //   CREATING SUCCESSED AND FAILED ARRAYS
    // --------------------------------------------

    for (let i = 0; i < ownSearch.length; i++) {
      try {
        let capital = await doSmthAll[i][1][0]["capitalCity"];
        let isoName = ownSearch[i]["alpha-2"];
        let counName = ownSearch[i]["name"];
        let imgSrc = `https://www.countryflags.io/${isoName}/shiny/64.png`;

        successResArr.push({
          "counName": counName,
          'capital': capital,
          'isoName': isoName,
          'imgSrc': imgSrc,
        });

      } catch (err) {
        console.error(`TYPE_ERROR_IN_FUNC_MY ${i}. KRASAVA`, err);
        failArr.push(i)
      }
    }

    // --------------------------------------------
    //  CREATING RESULT(S) AT NEW BLOCK
    // --------------------------------------------

    // single result
    if (successResArr.length == 1) {
      for (i = 0; i < ownSearch.length; i++) {
        if (failArr.indexOf(i) + 1) continue;
        if (divFound) divFound.remove();
        search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
        showInfo(ownSearch[i]["name"]);
      }
    } else {
      //many results
      let num = 0
      for (let i = 0; i < Math.min(5, successResArr.length); i++) {
        try {
          num++;
          let div = document.createElement("div");
          let p = document.createElement("p");
          let img = document.createElement("img");
          div.appendChild(p);
          div.appendChild(img);
          divMiniResults.appendChild(div);
          resultsComp.appendChild(divMiniResults);

          img.src = successResArr[i]['imgSrc'];
          p.innerHTML = `#${i + 1} <br> [${successResArr[i]['isoName']}] ${successResArr[i]['counName']}<br> capital: ${successResArr[i]["capital"]}`;
          div.className = "mini-result";
          divMiniResults.className = 'mini-results';
          div.tabIndex = 0;

          div.addEventListener("keydown", e => {
            if (e.key == "Enter") {
              div.dispatchEvent(new Event("click"));
            }
          });

          div.addEventListener("click", async e => {
            console.log(`click, i = ${i}`);
            search.value = successResArr[i]['counName'];
            search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
            if (divFound) divFound.remove();
            showInfo(search.value);
          });
        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`~~~~~~~~~~~~~~~~~TYPE_ERROR_IN_FUNC_MY ${num}. `, err);
            num--;
          } else {
            console.error("~~~~~~~~~~~~~~~~~~UKNOWN_ERROR_MY\n", err);
          }
        }
      }

      // pagination
      let pagContainer = document.createElement("div");
      pagContainer.className = "pagination";

      for (let i = 0; i < Math.ceil(successResArr.length / 5); i++) {
        if (successResArr.length <= 5) break;

        let paginNumber = document.createElement('button');
        paginNumber.innerHTML = `${i + 1}`;
        pagContainer.appendChild(paginNumber);
        resultsComp.appendChild(pagContainer);

        paginNumber.addEventListener("click", e => {
          let divMiniResults = document.querySelector('.mini-results');
          divMiniResults.innerHTML = "";

          for (let j = i * 5; j < Math.min(i * 5 + 5, successResArr.length); j++) {
            let div = document.createElement("div");
            let p = document.createElement("p");
            let img = document.createElement("img");
            div.appendChild(p);
            div.appendChild(img);
            divMiniResults.appendChild(div)

            img.src = successResArr[j]['imgSrc'];
            p.innerHTML = `#${j + 1} <br> [${successResArr[j]['isoName']}] ${successResArr[j]['counName']}<br> capital: ${successResArr[j]["capital"]}`;
            div.className = "mini-result";
            div.tabIndex = 0;

            div.addEventListener("keydown", e => {
              if (e.key == "Enter") {
                div.dispatchEvent(new Event("click"));
              }
            });

            div.addEventListener("click", async e => {
              console.log(`click, j = ${j}`, successResArr);
              search.value = successResArr[j]['counName'];
              console.log(`То что в массиве: ${successResArr.length}, Длинна массива: ${successResArr.length}`)
              console.log(`${successResArr[j]['counName']}`);
              search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
              if (divFound) divFound.remove();
              showInfo(search.value);
            });
          }
        });
      }
      if (divFound) divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";

      let pFound = document.querySelector('.results-component > p');
      if (successResArr.length == 0) {
        pFound.innerHTML = "no countries for your request";
      } else {
        pFound.innerHTML = "";
      }

      let h3 = document.createElement("h3");
      h3.innerHTML = `<strong>Found ${successResArr.length} countries:</strong>`;
      resultsComp.insertBefore(h3, resultsComp.firstElementChild);
    }

    // --------------------------------------------
    //          SHOW SINGLE RESULT
    // --------------------------------------------
    
    async function showInfo(countryName) {
      let ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(countryName.toLowerCase()));
      ownSearch = ownSearch[0];

      console.log("TCL: showInfo -> ownSearch['name']:", ownSearch['name'])
      console.log(`https://api.worldbank.org/v2/country/${ownSearch["alpha-2"]}?format=json`);

      let singleCap = await getSingleCountry(ownSearch["alpha-2"])

      let div = document.createElement("div");
      let h1 = document.createElement("h1");
      let p = document.createElement("p");
      let img = document.createElement("img");
      let iframe = document.createElement("iframe");
      let divInfo = document.createElement("div");
      
      h1.innerHTML = `${ownSearch["name"]}`;
      img.src = `https://www.countryflags.io/${ownSearch["alpha-2"]}/shiny/64.png`;
      p.innerHTML = `INFO <br> [${ownSearch["alpha-2"]}] <br> Capital city: ${singleCap[1][0]["capitalCity"]}`;
      iframe.src = `https://www.google.com/maps/embed/v1/place?key=AIzaSyB-AB34OTQFNDISPRKrYRGmU7SQ5utBEaw&q=${singleCap[1][0]["capitalCity"]} ${singleCap[1][0]["name"]}`;
      iframe.setAttribute("allow", "fullscreen");
      div.className = "mini-result-single";
      divInfo.appendChild(p);
      divInfo.appendChild(img);
      div.appendChild(h1);
      // div.appendChild(p);
      // div.appendChild(img);
      div.appendChild(divInfo);
      div.appendChild(iframe);
      resultsComp.innerHTML = "";
      resultsComp.appendChild(div);
      // return `HELLO ${countryName}`;
    }
  }

  // funnction helper to show results
  async function getSingleCountry(country) {
    const singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${country}?format=json`);
    const singleCap = await singleCapJson.json();
    return singleCap;
  }
  inputBtn.onclick = miniResults;


  // --------------------------------------------
  //  RETURN ARR OF [NAME <-> ALPHACODE] COUNTRY ASSOCIATION 
  // --------------------------------------------
  async function getCountry(elt1) {
    const countriesJson = await fetch("country.json");
    const countries = await countriesJson.json();

    const foundCountries = countries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    let p = document.createElement('p');
    p.innerHTML = "Searching, wait a bit"
    elt1.appendChild(p);

    return foundCountries;
  }




</script>
</html>