<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/country-info/assets/css/reset.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/main.css" type="text/css">
    <link rel="stylesheet" href="/country-info/assets/css/media-queries.css" type="text/css">
</head>
<body>
  <div class="container">
    <section class="search-component">
      <h1>Country info</h1>
      <label>
        <input name="searchCountry" placeholder="type country name" id="" autocomplete="off" tabindex="2">
        <input type="button" name="showBtn" value="show">
      </label>
    </section>
    <section class="results-component"></section>

  </div>

</body>
<script>
  let countryAPI = `http://api.worldbank.org/v2/country/br?format=json`;
  let search = document.querySelector("input[name='searchCountry']");
  let inputBtn = document.querySelector("input[name='showBtn']")
  let controller = new AbortController();


  let label = document.querySelector('.search-component > label')
  label.addEventListener("click", (e) => e.preventDefault());


  search.focus();
  search.addEventListener("keydown", e => {
    if (e.key == "Enter") {
      inputBtn.dispatchEvent(new Event("click"));
    }
  })

  // -----------------------INPUT---------------------------------

  search.addEventListener("input", async e => {
    // console.clear();
    controller.abort();
    controller = new AbortController();



    if (search.value == "") {
      let divFound = document.querySelector(".search-component > label > div");
      divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
      return;
    }

    let divFound = document.querySelector(".search-component > label > div");
    if (divFound) divFound.remove();
    let number = 0;
    let div = document.createElement('div');
    let ul = document.createElement('ul');
    let li = document.createElement('li');
    // div.style.position = "absolute";
    // div.style.top = "40px";
    div.style.width = "90%";
    div.style.backgroundColor = "white";
    div.style.display = "block";
    // div.style.minHeight = "150px";
    div.appendChild(ul);

    let foundCountries = await getCountry(div);

    if (foundCountries.length == 0) {
      let divFound = document.querySelector(".search-component > label > div");
      if (!divFound) search.parentElement.insertBefore(div, inputBtn);
      let p2 = document.querySelector(".search-component > label > div > p");
      if (p2) p2.remove();
      let p = document.createElement('p');
      p.innerHTML = "nothing found";
      div.appendChild(p);
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";
    } else {
      search.parentElement.insertBefore(div, inputBtn);
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "0";
    }

    try {
      let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
      let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));


      for (let i = 0; i < foundCountries.length; i++) {
        try {
          // alert(foundCountries.length) 

          if (number < 10) {
            number++;
            if (number == 1) {
              ul.innerHTML = "";
            }
            let li = document.createElement('li');
            li.innerHTML = `${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}, capital: ${doSmthAll[i][1][0]["capitalCity"]}`;
            li.addEventListener("click", e => {
              search.value = `${foundCountries[i]["name"]}`;
              search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
              let divFound = document.querySelector(".search-component > label > div");
              divFound.remove();
            });
            ul.appendChild(li);
            let p = document.querySelector(".search-component > label > div > p");
            if (p) p.remove();
          } else if (number == 10) {
            number++;
            let p = document.createElement('p');
            p.innerHTML = "...";
            div.appendChild(p);
          }

        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`TYPE_ERROR_MY ${number}. [${foundCountries[i]["alpha-2"]}] ${foundCountries[i]["name"]}\n`, err);
            number--;
          } else {
            console.error("UKNOWN_ERROR_MY\n", err);
          }
        }
      }



    } catch (err) {
      if (err instanceof DOMException) {
        console.error("ABORT_ERROR_MY\n", err);
      } else {
        console.error("UKNOWN_ERROR_MY_OUTER\n", err);
      }

    }
  });












  // let foundCountries = await getCountry(div);
  // let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
  // let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));













  // function pagination(lowInd) {

  //   return 
  async function miniResults(e) {
    // miniResArr = [];
    let miniResArr = [];
    let resultsComp = document.querySelector(".results-component");
    let ownSearch;


    // searchAllBtn.removeEventListener("click", miniResults);
    // search.dispatchEvent(new Event('input'));
    // alert(number)
    let num = 0;
    resultsComp.innerHTML = "";
    let divMiniResults = document.createElement('div');
    let foundCountries = await getCountry(resultsComp);
    let pSearch = document.querySelector(".results-component > p")

    let doSmthAllJson = await Promise.all(foundCountries.map(i => fetch(`https://api.worldbank.org/v2/country/${i["alpha-2"]}?format=json`, { signal: controller.signal })));
    let doSmthAll = await Promise.all(doSmthAllJson.map(i => i.json()));
    // divMiniResults.className = 'mini-results';
    let divFound = document.querySelector(".search-component > label > div");
    ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    console.log(`Меня кинуло сюда: ${ownSearch.length} -`, ownSearch);
    if (ownSearch.length == 0) return;

    // if (ownSearch.length == 1) {  // change condition
    //   if (divFound) divFound.remove();
    //   search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
    //   showInfo(ownSearch[0]["name"]);
    // } else {
    // let notSoSmartMove = Math.min((lowInd + 5), ownSearch.length);
    // alert(notSoSmartMove)


    let smartArr = [];
    // alert(e.target)
    // if (e.target != "undefined") {
    for (let i = 0; i < ownSearch.length; i++) {
      try {
        num++
        let capital = await doSmthAll[i][1][0]["capitalCity"];
        let isoName = ownSearch[i]["alpha-2"];
        let counName = ownSearch[i]["name"];
        let imgSrc = `https://www.countryflags.io/${isoName}/flat/64.png`;


        miniResArr.push({
          // 'number': num,
          "counName": counName,
          'capital': capital,
          'isoName': isoName,
          'imgSrc': imgSrc,
        });

      } catch (err) {
        console.error(`TYPE_ERROR_IN_FUNC_MY ${num}. `, err);
        smartArr.push(i)
        num--;
      }
    }
    // }
    // alert(num)
    // for (i of smartArr) {
    //   alert(i)
    // }
    // miniResArr.push(num);


    pSearch.remove();
    if (num == 1) {
      for (i = 0; i < ownSearch.length; i++) {
        if (smartArr.indexOf(i) + 1) continue;
        if (divFound) divFound.remove();
        search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
        showInfo(ownSearch[i]["name"]);
      }
    } else {
      let num2 = 0
      for (let i = 0; i < Math.min(5, miniResArr.length); i++) {
        // if (i == errArr[indexArr]) {
        //   indexArr++;
        //   continue;
        // }
        // if (smartArr.indexOf(i) + 1) {
        //   // if (ownSearch.length > notSoSmartMove) notSoSmartMove++;
        //   continue;
        // }
        try {
          num2++;
          // alert(i)
          let div = document.createElement("div");
          let p = document.createElement("p");
          let img = document.createElement("img");
          div.appendChild(p);
          div.appendChild(img);
          divMiniResults.appendChild(div);
          resultsComp.appendChild(divMiniResults);

          img.src = miniResArr[i]['imgSrc'];
          p.innerHTML = `#${i + 1} <br> [${miniResArr[i]['isoName']}] ${miniResArr[i]['counName']}<br> capital: ${miniResArr[i]["capital"]}`;
          div.className = "mini-result";
          divMiniResults.className = 'mini-results';
          div.tabIndex = 0;

          div.addEventListener("keydown", e => {
            if (e.key == "Enter") {
              div.dispatchEvent(new Event("click"));
            }
          });

          div.addEventListener("click", async e => {
            console.log(`click, i = ${i}`);
            search.value = miniResArr[i]['counName'];
            search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
            if (divFound) divFound.remove();
            showInfo(search.value);
          });
        } catch (err) {
          if (err instanceof TypeError) {
            console.error(`~~~~~~~~~~~~~~~~~TYPE_ERROR_IN_FUNC_MY ${num2}. `, err);
            // console.error(`TYPE_ERROR_IN_FUNC_MY ${num}. [${ownSearch[i]["alpha-2"]}] ${ownSearch[i]["name"]}\n`, err);
            num2--;
            if (ownSearch.length > notSoSmartMove) notSoSmartMove++;
          } else {
            console.error("~~~~~~~~~~~~~~~~~~UKNOWN_ERROR_MY\n", err);
          }
        }
      }
      // let bigger = Math.ceil(num/5);
      // alert(miniResArr[miniResArr.length - 1]);
      let pagContainer = document.createElement("div");
      pagContainer.className = "pagination";
      for (let i = 0; i < Math.ceil(miniResArr.length / 5); i++) {
        if (miniResArr.length <= 5) break;
        // console.log("KUKUSIKI VISHE");
        let paginNumber = document.createElement('button');
        paginNumber.innerHTML = `${i + 1}`;
        pagContainer.appendChild(paginNumber);
        resultsComp.appendChild(pagContainer);
        paginNumber.addEventListener("click", e => {
          let divMiniResults = document.querySelector('.mini-results');
          divMiniResults.innerHTML = "";
          for (let j = i * 5; j < Math.min(i * 5 + 5, miniResArr.length); j++) {
            console.log("KUKUSIKI");
            console.log(`${j} ${miniResArr[j]['isoName']} ${miniResArr[j]['counName']}`);
            let div = document.createElement("div");
            let p = document.createElement("p");
            let img = document.createElement("img");
            div.appendChild(p);
            div.appendChild(img);
            divMiniResults.appendChild(div)
            // resultsComp.appendChild(div);

            img.src = miniResArr[j]['imgSrc'];
            p.innerHTML = `#${j + 1} <br> [${miniResArr[j]['isoName']}] ${miniResArr[j]['counName']}<br> capital: ${miniResArr[j]["capital"]}`;
            div.className = "mini-result";
            div.tabIndex = 0;

            div.addEventListener("keydown", e => {
              if (e.key == "Enter") {
                div.dispatchEvent(new Event("click"));
              }
            });

            div.addEventListener("click", async e => {
              console.log(`click, j = ${j}`, miniResArr);
              search.value = miniResArr[j]['counName'];
              console.log(`То что в массиве: ${miniResArr.length}, Длинна массива: ${miniResArr.length}`)
              console.log(`${miniResArr[j]['counName']}`);
              search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
              if (divFound) divFound.remove();
              showInfo(search.value);
            });
          }
          // let p2 = document.createElement("p");
          // p2.innerHTML = `<strong>Found ${num} countries:</strong>`;
          // resultsComp.insertBefore(p2, resultsComp.firstElementChild);
        });
      }
      if (divFound) divFound.remove();
      search.style.borderBottomRightRadius = search.style.borderBottomLeftRadius = "20px";
      let p = document.createElement("p");
      p.innerHTML = `<strong>Found ${miniResArr.length} countries:</strong>`;
      console.log(`Может проблема в корневом #1: ${resultsComp.innerHTML}`);
      resultsComp.insertBefore(p, resultsComp.firstElementChild);
      console.log(`Может проблема в корневом #2: ${resultsComp.innerHTML}`);
    }
    async function showInfo(countryName) {
      let ownSearch = foundCountries.filter(i => i.name.toLowerCase().includes(countryName.toLowerCase()));
      let singleCountry = ownSearch.filter(i => i.name == countryName);
      singleCountry = singleCountry[0];
      console.log("TCL: showInfo -> singleCountry", singleCountry['name'])
      console.log(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
      // let singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
      // let singleCap = await singleCapJson.json();
      // let singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${singleCountry["alpha-2"]}?format=json`);
      let singleCap = await getSingleCountry(singleCountry["alpha-2"])
      let div = document.createElement("div");
      let h1 = document.createElement("h1");
      let p = document.createElement("p");
      let img = document.createElement("img");
      h1.innerHTML = `${singleCountry["name"]}`;
      img.src = `https://www.countryflags.io/${singleCountry["alpha-2"]}/flat/64.png`;
      p.innerHTML = `INFO <br> [${singleCountry["alpha-2"]}] <br> capital: ${singleCap[1][0]["capitalCity"]}`;
      div.className = "mini-result-single";
      div.appendChild(h1);
      div.appendChild(p);
      div.appendChild(img);
      resultsComp.innerHTML = "";
      resultsComp.appendChild(div);
      return `HELLO ${countryName}`;
    }
  }

  inputBtn.onclick = miniResults;

  async function getSingleCountry(country) {
    const singleCapJson = await fetch(`https://api.worldbank.org/v2/country/${country}?format=json`);
    const singleCap = await singleCapJson.json();
    return singleCap;
  }



  async function getCountry(elt1) {
    const countriesJson = await fetch("country.json");
    const countries = await countriesJson.json();

    const foundCountries = countries.filter(i => i.name.toLowerCase().includes(search.value.toLowerCase())); //await ???
    let p = document.createElement('p');
    p.innerHTML = "Searching, wait a bit"
    elt1.appendChild(p);

    return foundCountries;
  }




</script>
</html>